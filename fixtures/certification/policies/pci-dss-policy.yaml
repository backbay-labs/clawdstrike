# pci-dss-policy.yaml
# Clawdstrike PCI-DSS Compliance Policy Template
# Version: 1.1.0

version: "1.1.0"
name: "PCI-DSS Compliance Policy"
description: "Policy template for PCI-DSS compliant AI agent deployments"
extends: clawdstrike:strict

guards:
  # Cardholder Data Protection (Req 3, 7)
  forbidden_path:
    enabled: true
    patterns:
      # Cardholder data storage
      - "**/cardholder/**"
      - "**/cde/**"
      - "**/payment/**"
      - "**/transactions/**"
      - "**/cards/**"
      - "**/pan/**"

      # Encryption keys (Req 3.5, 3.6)
      - "**/keys/**"
      - "**/certs/**"
      - "**/*.key"
      - "**/*.pem"
      - "**/*.p12"
      - "**/*.pfx"
      - "**/keystore/**"
      - "**/vault/**"

      # HSM and tokenization
      - "**/hsm/**"
      - "**/tokens/**"

      # Standard sensitive paths
      - "**/.ssh/**"
      - "**/.aws/**"
      - "**/.gnupg/**"
      - "**/secrets/**"
      - "**/.env"
      - "**/.env.*"

    exceptions:
      # Public certificates only
      - "**/certs/public/**"
      - "**/*.pub"

    additional_patterns:
      # Organization-specific CDE paths
      # Add your paths here

  # Network Segmentation (Req 1.3)
  egress_allowlist:
    enabled: true
    default_action: deny
    allow:
      # Approved payment gateways
      # Add your specific endpoints
      - "api.stripe.com"
      - "api.braintreegateway.com"
      - "api.paypal.com"

      # Package registries (non-CDE)
      - "pypi.org"
      - "registry.npmjs.org"

      # AI provider APIs (ensure no CHD transmitted)
      - "api.anthropic.com"
      - "api.openai.com"

    block:
      # CDE network segments (prevent bridging)
      - "10.100.*"          # Example CDE subnet
      - "172.16.100.*"      # Example CDE subnet

      # Explicitly blocked
      - "*.onion"
      - "localhost"
      - "127.0.0.1"

  # Cardholder Data Detection (Req 3.4, 8.2.1)
  secret_leak:
    enabled: true
    redact: true
    severity_threshold: critical  # Block on CHD detection
    patterns:
      # Primary Account Number (PAN)
      - name: "pan_visa"
        pattern: '\b4[0-9]{12}(?:[0-9]{3})?\b'
        severity: critical
        description: "Visa card number"

      - name: "pan_mastercard"
        pattern: '\b(?:5[1-5][0-9]{2}|222[1-9]|22[3-9][0-9]|2[3-6][0-9]{2}|27[01][0-9]|2720)[0-9]{12}\b'
        severity: critical
        description: "Mastercard card number"

      - name: "pan_amex"
        pattern: '\b3[47][0-9]{13}\b'
        severity: critical
        description: "American Express card number"

      - name: "pan_discover"
        pattern: '\b6(?:011|5[0-9]{2}|4[4-9][0-9])[0-9]{12,15}\b'
        severity: critical
        description: "Discover card number"

      - name: "pan_jcb"
        pattern: '\b(?:352[89]|35[3-8][0-9])[0-9]{12,15}\b'
        severity: critical
        description: "JCB card number"

      - name: "pan_diners"
        pattern: '\b3(?:0[0-5]|[68][0-9])[0-9]{11,16}\b'
        severity: critical
        description: "Diners Club card number"

      - name: "pan_unionpay"
        pattern: '\b62[0-9]{14,17}\b'
        severity: critical
        description: "UnionPay card number"

      - name: "pan_generic"
        pattern: '\b[0-9]{13,19}\b'
        severity: high
        description: "Potential card number (generic - requires Luhn validation)"

      # CVV/CVC (MUST NEVER BE STORED)
      - name: "cvv"
        pattern: '\b(cvv|cvc|cvv2|cvc2|cid)[:\s]*[0-9]{3,4}\b'
        severity: critical
        description: "Card verification value"

      # Track data (magnetic stripe)
      - name: "track1"
        pattern: '%B[0-9]{13,19}\^[^\^]+\^[0-9]{4}[0-9]+\?'
        severity: critical
        description: "Track 1 magnetic stripe data"

      - name: "track2"
        pattern: ';[0-9]{13,19}=[0-9]{4}[0-9]+\?'
        severity: critical
        description: "Track 2 magnetic stripe data"

      # PIN blocks
      - name: "pin_block"
        pattern: '\b(pin|pin_block)[:\s]*[0-9A-Fa-f]{16}\b'
        severity: critical
        description: "PIN block"

      # Encryption keys
      - name: "encryption_key"
        pattern: '\b(dek|kek|bdk|ipek|ksn)[:\s]*[0-9A-Fa-f]{32,64}\b'
        severity: critical
        description: "Encryption key"

      # Standard secrets
      - name: "api_key"
        pattern: '(?i)(api[_-]?key|apikey)["\s:=]+["'']?([a-zA-Z0-9_\-]{20,})["'']?'
        severity: high

  # Secure Development (Req 6.4, 6.5)
  patch_integrity:
    enabled: true
    forbidden_patterns:
      # Dangerous patterns
      - 'eval\s*\('
      - 'exec\s*\('
      - 'system\s*\('
      - 'subprocess\.call'
      - 'os\.popen'

      # SQL injection risks
      - 'SELECT.*\+.*FROM'
      - 'INSERT.*\+.*INTO'
      - 'EXECUTE\s+IMMEDIATE'

      # Payment-specific dangerous patterns
      - 'decrypt.*pan'
      - 'log.*card'
      - 'print.*cvv'
      - 'console\.log.*payment'

  # Tool Restrictions (Req 7.2)
  mcp_tool:
    enabled: true
    default_action: deny
    allow:
      - "read"            # File reading
      - "glob"            # File search
      - "grep"            # Content search
      - "bash"            # With command restrictions

    deny:
      - "webfetch"        # Prevent arbitrary network
      - "database_query"  # Prevent direct DB access
      - "mcp_*"           # Block unknown tools

  # Prompt Injection Defense (additional security)
  prompt_injection:
    enabled: true
    max_scan_bytes: 100000
    warn_at_or_above: low
    block_at_or_above: medium

settings:
  fail_fast: true
  verbose_logging: true
  session_timeout_secs: 1800  # 30 minutes
